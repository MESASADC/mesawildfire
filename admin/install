#!/bin/bash

# Script to install MESA Wildfire software unto a vinilla Ubuntu machine

set -x

HERE=$(readlink -f `dirname $0`)
MESA_ROOT=$(readlink -f $HERE/..)
VOLUMES=$MESA_ROOT/volumes

export DEBIAN_FRONTEND=noninteractive


# Customize settings
cp $MESA_ROOT/django_project/ENV.example $MESA_ROOT/django_project/ENV
read -p "Press [Enter] key to open the editor"
nano $MESA_ROOT/django_project/ENV


# General
apt-get update
apt-get upgrade -y
apt-get install -y git nano vi
apt-get install curl

# Install Docker - https://docs.docker.com/installation/ubuntulinux/
apt-key adv --keyserver hkp://pgp.mit.edu:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main" >> /etc/apt/sources.list.d/docker.list
apt-get update
apt-get purge -y lxc-docker*
apt-cache policy docker-engine
apt-get install -y docker-engine
docker run hello-world


# Install GeoNode
#docker build -t geonode https://github.com/GeoNode/geonode.git
#mkdir $VOLUMES/geonode_data/workspaces
#cp -r $MESA_ROOT/admin/geoserver/mesa $VOLUMES/geonode_data/workspaces/


# Install PostGIS
docker pull kartoza/postgis
docker run -it --rm -v $MESA_ROOT/volumes/postgis:/var/lib/postgresql kartoza/postgis bash -c 'chown postgres: /var/lib/postgresql && su postgres -c "/usr/lib/postgresql/9.4/bin/initdb -D /var/lib/postgresql/data"' # initialize data directory
cp $HERE/pg_hba.conf $MESA_ROOT/volumes/postgis/9.4/main/  # allow login from any ip address


# Install Geoserver
docker pull kartoza/geoserver

#Install RabbitMQ
#docker pull rabbitmq:3-management
cd $HERE/rabbitmq
./build


# Install Nginx
cd $MESA_ROOT/nginx
./build



# Install ingest scripts
apt-get install -y python-jinja2 incron python-kombu

# Install gsconfig scripts
apt-get install python-pip
pip install gsconfig

# Install supervisord
# See: http://serverfault.com/questions/96499/how-to-automatically-start-supervisord-on-linux-ubuntu
apt-get install -y supervisor
cp $HERE/supervisord/init.d/supervisor /etc/init.d/supervisor
chmod +x /etc/init.d/supervisor

cd $HERE/supervisord
./update_conf

#FILES=$HERE/supervisord/conf.d/*
#for f in $FILES; do
#  TARGET=/etc/supervisor/conf.d/$(basename $f)
#  cat $f | sed -e "s|MESA_ROOT=\".*|MESA_ROOT=$MESA_ROOT|g" > $TARGET
#  echo "$f --> $TARGET"
#done;

# Make supervisor start up on boot
update-rc.d supervisor defaults
service supervisor stop
service supervisor start
service supervisor status


#Add Geoserver layers 
cd $MESA_ROOT/admin/geoserver
python configure.py


# Install MESA Wildfire application
cd $MESA_ROOT/django_project
./build
./manage migrate --noinput


# Initialize MESA Viewer
cd $MESA_ROOT/mesa-viewer
cp ENV.example ENV
./build
RUN_MODE=-it ./run env AFIS_VIEWER_INIT=1 python /tmp/django_project/manage.py syncdb --noinput
RUN_MODE=-it ./run env AFIS_VIEWER_INIT= python /tmp/django_project/manage.py syncdb --noinput

# Restart dockers
service supervisor restart
